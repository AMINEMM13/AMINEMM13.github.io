<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>VideoApp 설치 및 실행</title>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
  <h1>VideoApp 설치 및 실행</h1>
  <p>먼저 아래 버튼을 눌러 VideoApp을 다운로드하고, 설치 완료 후 다시 이 페이지로 돌아오세요.</p>
  <!-- Google Drive 직접 다운로드 링크 -->
  <a href="https://drive.google.com/uc?export=download&id=10dMkvU8wIZznYfZZ3wPJnHkyeABNt-Bu" target="_blank">
    <button type="button">앱 설치</button>
  </a>
  <hr>
  <h2>업로드 및 진행</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <label>텍스트 파일 (.txt)</label>
    <input type="file" id="textfile" accept=".txt"><br>
    <label>이미지 파일</label>
    <input type="file" id="images" multiple><br>
    <label>웃음소리 넣기</label>
    <input type="radio" name="laugh" value="1">예
    <input type="radio" name="laugh" value="2" checked>아니오<br>
    <button type="submit">실행</button>
  </form>
  <div id="progress"><p>0% 진행 중…</p></div>
  <div id="download-section" style="display:none;">
    <h2>완료</h2>
    <a id="downloadLink" href="#"><button type="button">비디오 다운로드</button></a>
  </div>

  <script>
    async function isLocalUp() {
      try { await axios.get('https://aminemm13.github.io'); return true; }
      catch { return false; }
    }

    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!await isLocalUp()) {
        alert('앱을 설치하고 실행한 뒤 다시 시도하세요.');
        return;
      }
      const txt = document.getElementById('textfile').files[0];
      if (!txt || !txt.name.endsWith('.txt')) {
        alert('텍스트(.txt)를 선택하세요.'); return;
      }
      const imgs = document.getElementById('images').files;
      const laugh = document.querySelector('input[name="laugh"]:checked').value;
      const fd = new FormData();
      fd.append('textfile', txt);
      for (let f of imgs) fd.append('images', f);
      fd.append('laugh', laugh);

      // 로컬 포트 8329 로 전송하려면 아래 두 줄을 주석 해제
      // await axios.post('https://aminemm13.github.io:8329/', fd);
      // const evt = new EventSource('https://aminemm13.github.io:8329/progress');

      // 설치 시 portproxy 해두면 그냥 origin 으로
      await axios.post(window.location.origin + '/', fd);
      const evt = new EventSource(window.location.origin + '/progress');

      evt.onmessage = ev => {
        const p = +ev.data;
        document.getElementById('progress').innerHTML = `<p>${p}% 진행 중…</p>`;
        if (p === 100) {
          evt.close();
          document.getElementById('download-section').style.display = 'block';
          document.getElementById('downloadLink').href =
            `${window.location.origin}/download/${txt.name}`;
        }
      };
    });
  </script>
</body>
</html>
